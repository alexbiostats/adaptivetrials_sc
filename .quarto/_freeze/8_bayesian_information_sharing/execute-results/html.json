{
  "hash": "25911997f6b64b9a64b2c4ffe94595d5",
  "result": {
    "markdown": "---\ntitle: \"Bayesian Information Sharing\"\ntoc: true\ntoc_float: true\ntoc-location: left\nformat:\n  html:\n    code-fold: show\n    code-overflow: wrap \n    code-tools: true\n---\n\n::: {.cell}\n\n:::\n\n\n\n# Overview\n\nClinical trials do not often occur out of thin air, oftentimes they are an evolution across multiple phases of research across many different populations. In many settings, we may have access to historic, supplemental, or external data that we could incorporate directly into our trial analysis beyond simply using them for a power calculation to motivate the target sample size. In this module we introduce Bayesian approaches to information sharing and discuss some of the strengths and challenges of implementing these approaches that may allow you to enroll fewer prospective participants and increase study power, albeit at a risk of increased bias in some scenarios.\n\n\n# Slide Deck\n\n<iframe class=\"speakerdeck-iframe\" style=\"border: 0px; background: rgba(0, 0, 0, 0.1) padding-box; margin: 0px; padding: 0px; border-radius: 6px; box-shadow: rgba(0, 0, 0, 0.2) 0px 5px 40px; width: 100%; height: auto; aspect-ratio: 560 / 315;\" frameborder=\"0\" src=\"https://speakerdeck.com/player/5a2ffc83655b4dafaae254de01753cd3\" title=\"Bayesian Methods for Information Sharing\" allowfullscreen=\"true\" data-ratio=\"1.7777777777777777\"></iframe>\n\n&nbsp;\n\nYou can also download the [original PowerPoint file](./files/Slides/8_bayesian_information_sharing.pptx).\n\n\n# Code Examples in R\n\nThere has been a lot of recent growth in creating packages that make information sharing methods accessible. Some options include:\n\n* [`basket`](https://cran.rstudio.com/web/packages/basket/index.html): implements asymmetric multi-source exchangeability models (MEMs) for basket trial designs where we wish to evaluate if pooling subgroups is possible based on exchangeability, restricted to binary outcomes\n* [`RBesT`](https://cran.r-project.org/web/packages/RBesT/index.html): implements meta-analytic priors (MAPs) for information sharing across multiple outcome types, lots of vignettes to demonstrate how to use the package\n* [`BayesPPD`](https://cran.r-project.org/web/packages/BayesPPD/index.html): implements power priors and related methods for information sharing\n* [`psborrow`](https://cran.r-project.org/web/packages/psborrow/index.html): implements methods that combine propensity scores and Bayesian dynamic borrowing methods\n\n\n## Example with MAPs and `RBesT`\n\nThe following example builds from a homework assignment I used in an advanced clinical trials course. It focuses on `RBesT` and implementing MAPs for a hypothetical study.\n\nFor the MAP-related questions, we will assume we have three supplemental sources of data. Each source has $n=50$ and $\\sigma=20$:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(RBesT)\n\ndat <- data.frame(\n  study = c('Study 1','Study 2','Study 3'),\n  n = c(50,50,50),\n  y = c(5,7,15)\n)\n\nstudy_sigma <- 20 # set common SD\ndat$y.se <- study_sigma / sqrt(dat$n)\n```\n:::\n\n\n### Explore different specifications of the half-normal prior for $\\tau$\n\nOne of the great things about RBesT package is that they've provided a wide range of possibilities to specify a prior on our between-study variance, denoted $\\sigma^2_{\\eta}$ in our van Rosmalen reading (2018) or $\\tau$ in the RBesT package. This includes the default half-normal prior, but also truncated normal, uniform, gamma, inverse gamma, log-normal, truncated Cauchy, exponential, and fixed options! \n\nFor the purpose of this homework, we first want to fit the general MAP prior with 3 different half-normal specifications ($\\tau \\sim HN(0,\\sigma_{\\tau})$):  \n1. Prior $\\sigma_{\\tau}$ of study_sigma / 2 = 10 (the prior used in the RBesT vignette for their example, stored in object map_mcmc_tauHN)  \n2. Prior $\\sigma_{\\tau}$ of study_sigma x 10 = 200 (a larger prior value on the between-study variability, stored in object map_mcmc_tauHNv2)  \n3. Prior $\\sigma_{\\tau}$ of study_sigma / 20 = 1 (a smaller prior value on the between-study variability, stored in object map_mcmc_tauHNv3)  \n\n\n::: {.cell hash='8_bayesian_information_sharing_cache/html/map-calcs_d685f55f85cf69a20c783a1689229bb5'}\n\n```{.r .cell-code}\n### Derivation of MAP prior\n## Half-normal tau prior with study_sigma/2\nset.seed(1234) #set to ensure reproducibility of the MCMC estimate\nmap_mcmc_tauHN <- gMAP(cbind(y, y.se) ~ 1 | study, \n                 weights=n,\n                 data=dat,\n                 family=gaussian,\n                 beta.prior=cbind(0, study_sigma),\n                 tau.dist=\"HalfNormal\",\n                 tau.prior=cbind(0,study_sigma/2))\nprint(map_mcmc_tauHN)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nGeneralized Meta Analytic Predictive Prior Analysis\n\nCall:  gMAP(formula = cbind(y, y.se) ~ 1 | study, family = gaussian, \n    data = dat, weights = n, tau.dist = \"HalfNormal\", tau.prior = cbind(0, \n        study_sigma/2), beta.prior = cbind(0, study_sigma))\n\nExchangeability tau strata: 1 \nPrediction tau stratum    : 1 \nMaximal Rhat              : 1 \nEstimated reference scale : 20 \n\nBetween-trial heterogeneity of tau prediction stratum\n  mean     sd   2.5%    50%  97.5% \n 6.380  4.160  0.684  5.550 17.100 \n\nMAP Prior MCMC sample\n  mean     sd   2.5%    50%  97.5% \n  8.53   9.22 -11.70   8.79  27.20 \n```\n:::\n\n```{.r .cell-code}\n## Half-normal tau prior with study_sigma*10\nset.seed(1234) #set to ensure reproducibility of the MCMC estimate\nmap_mcmc_tauHNv2 <- gMAP(cbind(y, y.se) ~ 1 | study, \n                       weights=n,\n                       data=dat,\n                       family=gaussian,\n                       beta.prior=cbind(0, study_sigma),\n                       tau.dist=\"HalfNormal\",\n                       tau.prior=cbind(0,study_sigma*10))\nprint(map_mcmc_tauHNv2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nGeneralized Meta Analytic Predictive Prior Analysis\n\nCall:  gMAP(formula = cbind(y, y.se) ~ 1 | study, family = gaussian, \n    data = dat, weights = n, tau.dist = \"HalfNormal\", tau.prior = cbind(0, \n        study_sigma * 10), beta.prior = cbind(0, study_sigma))\n\nExchangeability tau strata: 1 \nPrediction tau stratum    : 1 \nMaximal Rhat              : 1 \nEstimated reference scale : 20 \n\nBetween-trial heterogeneity of tau prediction stratum\n mean    sd  2.5%   50% 97.5% \n12.90 14.70  1.03  8.35 55.00 \n\nMAP Prior MCMC sample\n  mean     sd   2.5%    50%  97.5% \n  7.63  20.60 -35.10   8.33  44.30 \n```\n:::\n\n```{.r .cell-code}\n## Half-normal tau prior with study_sigma/20\nset.seed(1234) #set to ensure reproducibility of the MCMC estimate\nmap_mcmc_tauHNv3 <- gMAP(cbind(y, y.se) ~ 1 | study, \n                       weights=n,\n                       data=dat,\n                       family=gaussian,\n                       beta.prior=cbind(0, study_sigma),\n                       tau.dist=\"HalfNormal\",\n                       tau.prior=cbind(0,study_sigma/20))\nprint(map_mcmc_tauHNv3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nGeneralized Meta Analytic Predictive Prior Analysis\n\nCall:  gMAP(formula = cbind(y, y.se) ~ 1 | study, family = gaussian, \n    data = dat, weights = n, tau.dist = \"HalfNormal\", tau.prior = cbind(0, \n        study_sigma/20), beta.prior = cbind(0, study_sigma))\n\nExchangeability tau strata: 1 \nPrediction tau stratum    : 1 \nMaximal Rhat              : 1 \nEstimated reference scale : 20 \n\nBetween-trial heterogeneity of tau prediction stratum\n mean    sd  2.5%   50% 97.5% \n0.948 0.672 0.040 0.834 2.460 \n\nMAP Prior MCMC sample\n mean    sd  2.5%   50% 97.5% \n 8.91  2.11  4.75  8.88 13.10 \n```\n:::\n:::\n\n\n### Forest Plots to View Our Data\n\nOne helpful way to understand the data and the impact of the MAP prior is to graph it. The RBesT package include forest plots that are easy to create from our gMAP objects saved above. Note: the default is the lighter blue dashed line is the original data, the dark blue solid line is the MAP estimate.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Plot forest plots\nprint( plot(map_mcmc_tauHN)$forest_model )\n```\n\n::: {.cell-output-display}\n![](8_bayesian_information_sharing_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n```{.r .cell-code}\nprint( plot(map_mcmc_tauHNv2)$forest_model )\n```\n\n::: {.cell-output-display}\n![](8_bayesian_information_sharing_files/figure-html/unnamed-chunk-3-2.png){width=672}\n:::\n\n```{.r .cell-code}\nprint( plot(map_mcmc_tauHNv3)$forest_model )\n```\n\n::: {.cell-output-display}\n![](8_bayesian_information_sharing_files/figure-html/unnamed-chunk-3-3.png){width=672}\n:::\n:::\n\n\n### Converting the estimated MAP from the MCMC into a parametric approximation for use in later steps\n\nThe gMAP objects that were estimated given our different priors above were estimated using the MCMC chains fit with rstan. However, to apply these estimates in the process of estimating our trial performance we need to approximate the MAP in some (parametric) way. Within RBesT we can achieve this by using the automixfit function, which takes our MCMC output for the object and uses an expectation-maximization (EM) algorithm to estimate a parametric mixture of different components.\n\nWe can also note that RBesT includes a function to visualize the mixtures:\n\n\n::: {.cell hash='8_bayesian_information_sharing_cache/html/automix-chunk_12d165a856b46dc0e4c0a495ae277903'}\n\n```{.r .cell-code}\n## Approximation of MAP Prior using a mixture distribution\nmap <- automixfit(map_mcmc_tauHN)\nmapv2 <- automixfit(map_mcmc_tauHNv2)\nmapv3 <- automixfit(map_mcmc_tauHNv3)\n\nprint(map)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nEM for Normal Mixture Model\nLog-Likelihood = -14041.76\n\nUnivariate normal mixture\nReference scale: 20\nMixture Components:\n  comp1      comp2      comp3     \nw  0.4884107  0.4625307  0.0490586\nm  8.9697909  8.3180233  6.0787268\ns  3.7118243 10.3381879 24.0664794\n```\n:::\n\n```{.r .cell-code}\nprint(mapv2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nEM for Normal Mixture Model\nLog-Likelihood = -16253.76\n\nUnivariate normal mixture\nReference scale: 20\nMixture Components:\n  comp1       comp2       comp3       comp4      \nw  0.38367072  0.33720288  0.23881644  0.04030997\nm  8.51390751  8.48768978  6.97075811 -4.13223612\ns  4.28683959 10.91393632 25.08149588 73.81527800\n```\n:::\n\n```{.r .cell-code}\nprint(mapv3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nEM for Normal Mixture Model\nLog-Likelihood = -8626.03\n\nUnivariate normal mixture\nReference scale: 20\nMixture Components:\n  comp1     comp2    \nw 0.5375988 0.4624012\nm 8.8567284 8.9741893\ns 1.5686685 2.6002141\n```\n:::\n\n```{.r .cell-code}\n# Check accuracy of mixture fits\nplot(map)$mix\n```\n\n::: {.cell-output-display}\n![](8_bayesian_information_sharing_files/figure-html/automix-chunk-1.png){width=672}\n:::\n\n```{.r .cell-code}\nplot(mapv2)$mix\n```\n\n::: {.cell-output-display}\n![](8_bayesian_information_sharing_files/figure-html/automix-chunk-2.png){width=672}\n:::\n\n```{.r .cell-code}\nplot(mapv3)$mix\n```\n\n::: {.cell-output-display}\n![](8_bayesian_information_sharing_files/figure-html/automix-chunk-3.png){width=672}\n:::\n:::\n\n\n### The effective sample size of each prior\n\nAs our final stop in comparing the performance of different prior specifications on $\\tau$ we can examine the resulting effective sample size that would be imparted by the differing choices of our prior. Interestingly, there are multiple methods one can use in calculating the contribution of a given prior. The RBesT package has the functionlity to estimate three:  elir, moment, or morita. The elir method is the expected local information ratio proposed by Neuenschwander et al. in a paper under review and is the default method. The method approaches utilizes the mean and SD of the mixture which are then approximated by conjugate distributions with the same mean and SD. Finally, morita is a method proposed by Morita that utilizes the mode instead of the mean.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Effective Sample Size (ESS)\nround(ess(map)) #default elir method\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 10\n```\n:::\n\n```{.r .cell-code}\nround(ess(mapv2)) #default elir method\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 5\n```\n:::\n\n```{.r .cell-code}\nround(ess(mapv3)) #default elir method\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 95\n```\n:::\n:::\n\n\n\n# References\n\nBelow are some references to highlight based on the slides and code:\n\n* [FDA Adaptive Design Clinical Trials for Drugs and Biologics Guidance for Industry Guidance Document](https://www.fda.gov/regulatory-information/search-fda-guidance-documents/adaptive-design-clinical-trials-drugs-and-biologics-guidance-industry): FDA guidance document on adaptive trial elements\n\n* [A practical guide to adopting Bayesian analyses in clinical research](https://www.cambridge.org/core/journals/journal-of-clinical-and-translational-science/article/practical-guide-to-adopting-bayesian-analyses-in-clinical-research/CF6C017318CD5431C98EEFE37DBB6063?utm_campaign=shareaholic&utm_medium=copy_link&utm_source=bookmark): 2024 tutorial paper exploring the Bayesian approach to statistics and how to apply the methods for clinical trials",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}